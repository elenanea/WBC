# Математическое описание алгоритма блочного шифра WBC1

## Полное описание всех модификаций для научной публикации

---

## 1. ОБОЗНАЧЕНИЯ И НОТАЦИЯ

### 1.1. Основные параметры

- **$n$** — размер блока в битах: $n = 128$ (16 байт)
- **$r$** — номер раунда: $r \in \{1, 2, \ldots, R\}$
- **$R$** — общее количество раундов: $R \in \{16, 32, 64\}$
- **$k$** — размер ключа в битах: $k \in \{128, 192, 256\}$
- **$K$** — мастер-ключ: $K = (k_0, k_1, \ldots, k_{k/8-1})$, где $k_i \in \{0,1,\ldots,255\}$

### 1.2. Состояние блока

- **$X^{(r)}$** — состояние блока после раунда $r$
- **$X^{(0)}$** — открытый текст (plaintext): $X^{(0)} = (x_0, x_1, \ldots, x_{15})$
- **$X^{(R)}$** — зашифрованный текст (ciphertext)
- **$x_i$** — $i$-й байт блока: $x_i \in \{0,1,\ldots,255\}$

### 1.3. Ключевой материал

- **$RK_r$** — раундовый ключ для раунда $r$: $RK_r = (rk_{r,0}, rk_{r,1}, \ldots, rk_{r,15})$
- **$RK_r[j]$** — $j$-й байт раундового ключа $r$: $rk_{r,j} \in \{0,1,\ldots,255\}$
- Генерация: $RK_r = \text{SHA-256}(K \mathbin\Vert r_{BE})$, где $r_{BE}$ — номер раунда в big-endian

### 1.4. Табличные структуры

- **$S$** — S-box: $S: \{0,\ldots,255\} \to \{0,\ldots,255\}$
  - Подстановочная таблица, отображающая каждое байтовое **значение** в другое значение
  - Генерируется на основе ключа с использованием SHA-256 и MT19937
  - Пример: $S(42) = 178$ означает, что байт со значением 42 заменяется на значение 178
  
- **$S^{-1}$** — обратный S-box: $S^{-1}(S(x)) = x$

- **$\mathcal{P}$** — множество операций перестановок: $\mathcal{P} = \{\pi_0, \pi_1, \ldots, \pi_{126}\}$, где $|\mathcal{P}| = 127$

- **$\pi_i$** — $i$-я операция перестановки байтов: $\pi_i: \{0,\ldots,15\} \to \{0,\ldots,15\}$
  - **Важно:** $\pi_i$ оперирует **индексами позиций** байтов в блоке, а не их значениями
  - Это биекция (взаимно-однозначное отображение), то есть перестановка 16 позиций
  - Пример применения к блоку $X = (x_0, x_1, \ldots, x_{15})$:
    $$\Pi_i(X) = (x_{\pi_i(0)}, x_{\pi_i(1)}, \ldots, x_{\pi_i(15)})$$
  - Конкретный пример: если $\pi_3(0) = 5$, то байт с позиции 5 переместится на позицию 0
  - Основаны на операциях куба Рубика 2×2×4 (16 позиций = 16 байтов блока)
  
- **$\pi_i^{-1}$** — обратная операция перестановки: $\pi_i^{-1}(\pi_i(X)) = X$
  - Восстанавливает исходное расположение байтов

### 1.5. Операции

- **$\text{ROT}_\ell(b)$** — циклический сдвиг байта $b$ влево на $\ell$ бит: 
  $$\text{ROT}_\ell(b) = ((b \ll \ell) \mathbin| (b \gg (8-\ell))) \bmod 256$$

- **$\text{ROT}_r(b)$** — циклический сдвиг байта $b$ вправо на $r$ бит:
  $$\text{ROT}_r(b) = ((b \gg r) \mathbin| (b \ll (8-r))) \bmod 256$$

- **$\oplus$** — побитовая операция XOR

- **$\mathbin\Vert$** — конкатенация байтов

### 1.6. Функции алгоритма

- **$\Pi_{op}(X)$** — применение операции перестановки $op$ к блоку $X$
- **$\Sigma(X)$** — S-box подстановка: $\Sigma(X) = (S(x_0), S(x_1), \ldots, S(x_{15}))$
- **$\Sigma^{-1}(X)$** — обратная S-box подстановка: $\Sigma^{-1}(X) = (S^{-1}(x_0), S^{-1}(x_1), \ldots, S^{-1}(x_{15}))$
- **$\Phi(X)$** — диффузия (cumulative XOR)
- **$\Psi_\ell(X)$** — циклический побитовый сдвиг всех байтов блока

---

## 2. БАЗОВАЯ ВЕРСИЯ (wbc1_parallel.c, wbc1_parallel_cached.c)

### 2.1. MODE 0 — Упрощенная версия (1 операция на раунд)

#### Шифрование

Для каждого раунда $r = 1, 2, \ldots, R$:

**Шаг 1. Выбор операции:**
$$op_r = RK_r[0] \bmod 127$$

**Шаг 2. Применение перестановки:**
$$Y^{(r)} = \Pi_{op_r}(X^{(r-1)})$$

**Шаг 3. Циклический побитовый сдвиг:**

Вычисление величины сдвига:
$$\text{shift}_r = (r \bmod 8) + 1, \quad \text{shift}_r \in \{1, 2, \ldots, 8\}$$

Применение сдвига к каждому байту:
$$X^{(r)} = (\text{ROT}_r(y^{(r)}_0, \text{shift}_r), \text{ROT}_r(y^{(r)}_1, \text{shift}_r), \ldots, \text{ROT}_r(y^{(r)}_{15}, \text{shift}_r))$$

**Полная формула раунда:**
$$X^{(r)} = \Psi_{\text{shift}_r}(\Pi_{op_r}(X^{(r-1)}))$$

**Итоговый зашифрованный текст:**
$$C = X^{(R)}$$

#### Расшифрование

Для каждого раунда $r = R, R-1, \ldots, 1$ (в обратном порядке):

**Шаг 1. Обратный циклический сдвиг:**
$$\text{shift}_r = (r \bmod 8) + 1$$
$$Y^{(r)} = \Psi_{-\text{shift}_r}(X^{(r)})$$

где $\Psi_{-\ell}$ — сдвиг влево на $\ell$ бит (обратная операция):
$$\Psi_{-\ell}(X) = (\text{ROT}_\ell(x_0, \ell), \text{ROT}_\ell(x_1, \ell), \ldots, \text{ROT}_\ell(x_{15}, \ell))$$

**Шаг 2. Выбор операции:**
$$op_r = RK_r[0] \bmod 127$$

**Шаг 3. Обратная перестановка:**
$$X^{(r-1)} = \Pi_{op_r}^{-1}(Y^{(r)})$$

**Полная формула раунда:**
$$X^{(r-1)} = \Pi_{op_r}^{-1}(\Psi_{-\text{shift}_r}(X^{(r)}))$$

**Итоговый открытый текст:**
$$P = X^{(0)}$$

---

### 2.2. MODE 1 — Полная версия (5 операций на раунд)

#### Шифрование

Для каждого раунда $r = 1, 2, \ldots, R$:

**Шаг 1. Перестановка:**
$$op_r = RK_r[0] \bmod 127$$
$$T_1 = \Pi_{op_r}(X^{(r-1)})$$

**Шаг 2. XOR с раундовым ключом:**
$$T_2 = T_1 \oplus RK_r = (t_{1,0} \oplus rk_{r,0}, t_{1,1} \oplus rk_{r,1}, \ldots, t_{1,15} \oplus rk_{r,15})$$

**Шаг 3. S-box подстановка:**
$$T_3 = \Sigma(T_2) = (S(t_{2,0}), S(t_{2,1}), \ldots, S(t_{2,15}))$$

**Шаг 4. Многослойная диффузия:**

*Слой 1 (прямой cumulative XOR):*
$$d^{(1)}_0 = t_{3,0}$$
$$d^{(1)}_i = t_{3,i} \oplus d^{(1)}_{i-1}, \quad i = 1, 2, \ldots, 15$$

*Слой 2 (обратный cumulative XOR):*
$$d^{(2)}_{15} = d^{(1)}_{15}$$
$$d^{(2)}_i = d^{(1)}_i \oplus d^{(2)}_{i+1}, \quad i = 14, 13, \ldots, 0$$

$$T_4 = (d^{(2)}_0, d^{(2)}_1, \ldots, d^{(2)}_{15})$$

**Шаг 5. Циклический побитовый сдвиг:**
$$\text{shift}_r = (r \bmod 8) + 1$$
$$X^{(r)} = \Psi_{\text{shift}_r}(T_4)$$

**Полная формула раунда MODE 1:**
$$X^{(r)} = \Psi_{\text{shift}_r}(\Phi(\Sigma(\Pi_{op_r}(X^{(r-1)}) \oplus RK_r)))$$

где $\Phi$ — двухслойная диффузия.

**Итоговый зашифрованный текст:**
$$C = X^{(R)}$$

#### Расшифрование

Для каждого раунда $r = R, R-1, \ldots, 1$ (в обратном порядке):

**Шаг 1. Обратный циклический сдвиг:**
$$\text{shift}_r = (r \bmod 8) + 1$$
$$T_4 = \Psi_{-\text{shift}_r}(X^{(r)})$$

**Шаг 2. Обратная многослойная диффузия:**

*Обратный слой 2 (прямой cumulative XOR):*
$$d^{(1)}_{15} = d^{(2)}_{15}$$
$$d^{(1)}_i = d^{(2)}_i \oplus d^{(2)}_{i+1}, \quad i = 14, 13, \ldots, 0$$

*Обратный слой 1 (обратный cumulative XOR):*
$$t_{3,0} = d^{(1)}_0$$
$$t_{3,i} = d^{(1)}_i \oplus d^{(1)}_{i-1}, \quad i = 1, 2, \ldots, 15$$

$$T_3 = (t_{3,0}, t_{3,1}, \ldots, t_{3,15})$$

**Шаг 3. Обратная S-box подстановка:**
$$T_2 = \Sigma^{-1}(T_3) = (S^{-1}(t_{3,0}), S^{-1}(t_{3,1}), \ldots, S^{-1}(t_{3,15}))$$

**Шаг 4. XOR с раундовым ключом (самообратная операция):**
$$T_1 = T_2 \oplus RK_r$$

**Шаг 5. Обратная перестановка:**
$$op_r = RK_r[0] \bmod 127$$
$$X^{(r-1)} = \Pi_{op_r}^{-1}(T_1)$$

**Полная формула раунда MODE 1 (расшифрование):**
$$X^{(r-1)} = \Pi_{op_r}^{-1}((\Phi^{-1}(\Sigma^{-1}(\Psi_{-\text{shift}_r}(X^{(r)}))) \oplus RK_r))$$

**Итоговый открытый текст:**
$$P = X^{(0)}$$

---

## 3. УЛУЧШЕННАЯ ВЕРСИЯ (wbc1_parallel_new.c, wbc1_parallel_cached_new.c)

### Ключевое отличие: 32 операции на раунд

В улучшенной версии алгоритма вместо применения **одной** операции перестановки на раунд применяется **32 операции** (по одной для каждого байта раундового ключа).

### 3.1. MODE 0 — Улучшенная упрощенная версия (32 операции на раунд)

#### Шифрование

Для каждого раунда $r = 1, 2, \ldots, R$:

**Инициализация:**
$$T^{(r)}_0 = X^{(r-1)}$$

**Для каждого $j = 0, 1, \ldots, 31$:**

**Шаг 1. Выбор операции:**
$$op_{r,j} = RK_r[j] \bmod 127$$

**Шаг 2. Применение перестановки:**
$$Y_{r,j} = \Pi_{op_{r,j}}(T^{(r)}_j)$$

**Шаг 3. Циклический побитовый сдвиг:**

Вычисление величины сдвига (зависит от $j$ и $r$):
$$\text{shift}_{r,j} = ((j + r) \bmod 8) + 1, \quad \text{shift}_{r,j} \in \{1, 2, \ldots, 8\}$$

Применение сдвига к каждому байту:
$$T^{(r)}_{j+1} = \Psi_{\text{shift}_{r,j}}(Y_{r,j})$$

**Результат раунда:**
$$X^{(r)} = T^{(r)}_{32}$$

**Математически:**
$$X^{(r)} = \Psi_{\text{shift}_{r,31}}(\Pi_{op_{r,31}}(\Psi_{\text{shift}_{r,30}}(\Pi_{op_{r,30}}(\cdots \Psi_{\text{shift}_{r,0}}(\Pi_{op_{r,0}}(X^{(r-1)})) \cdots))))$$

Или в компактной форме:
$$X^{(r)} = \left(\prod_{j=31}^{0} \Psi_{\text{shift}_{r,j}} \circ \Pi_{op_{r,j}}\right)(X^{(r-1)})$$

где $\prod$ обозначает композицию функций справа налево.

**Итоговый зашифрованный текст:**
$$C = X^{(R)}$$

#### Расшифрование

Для каждого раунда $r = R, R-1, \ldots, 1$ (в обратном порядке):

**Инициализация:**
$$T^{(r)}_{32} = X^{(r)}$$

**Для каждого $j = 31, 30, \ldots, 0$ (в обратном порядке):**

**Шаг 1. Обратный циклический сдвиг:**
$$\text{shift}_{r,j} = ((j + r) \bmod 8) + 1$$
$$Y_{r,j} = \Psi_{-\text{shift}_{r,j}}(T^{(r)}_{j+1})$$

**Шаг 2. Выбор операции:**
$$op_{r,j} = RK_r[j] \bmod 127$$

**Шаг 3. Обратная перестановка:**
$$T^{(r)}_j = \Pi_{op_{r,j}}^{-1}(Y_{r,j})$$

**Результат раунда:**
$$X^{(r-1)} = T^{(r)}_0$$

**Математически:**
$$X^{(r-1)} = \left(\prod_{j=0}^{31} \Pi_{op_{r,j}}^{-1} \circ \Psi_{-\text{shift}_{r,j}}\right)(X^{(r)})$$

**Итоговый открытый текст:**
$$P = X^{(0)}$$

---

### 3.2. MODE 1 — Улучшенная полная версия (32 операции + дополнительные шаги на раунд)

#### Шифрование

Для каждого раунда $r = 1, 2, \ldots, R$:

**Фаза 1: 32 перестановки с ротациями**

$$T^{(r)}_0 = X^{(r-1)}$$

Для каждого $j = 0, 1, \ldots, 31$:
$$op_{r,j} = RK_r[j] \bmod 127$$
$$\text{shift}_{r,j} = ((j + r) \bmod 8) + 1$$
$$T^{(r)}_{j+1} = \Psi_{\text{shift}_{r,j}}(\Pi_{op_{r,j}}(T^{(r)}_j))$$

$$T_1 = T^{(r)}_{32}$$

**Фаза 2: XOR с раундовым ключом**
$$T_2 = T_1 \oplus RK_r$$

**Фаза 3: S-box подстановка**
$$T_3 = \Sigma(T_2)$$

**Фаза 4: Двухслойная диффузия**

*Слой 1 (прямой cumulative XOR):*
$$d^{(1)}_0 = t_{3,0}$$
$$d^{(1)}_i = t_{3,i} \oplus d^{(1)}_{i-1}, \quad i = 1, 2, \ldots, 15$$

*Слой 2 (обратный cumulative XOR):*
$$d^{(2)}_{15} = d^{(1)}_{15}$$
$$d^{(2)}_i = d^{(1)}_i \oplus d^{(2)}_{i+1}, \quad i = 14, 13, \ldots, 0$$

$$X^{(r)} = (d^{(2)}_0, d^{(2)}_1, \ldots, d^{(2)}_{15})$$

**Полная формула раунда MODE 1:**
$$X^{(r)} = \Phi\left(\Sigma\left(\left[\left(\prod_{j=31}^{0} \Psi_{\text{shift}_{r,j}} \circ \Pi_{op_{r,j}}\right)(X^{(r-1)})\right] \oplus RK_r\right)\right)$$

**Итоговый зашифрованный текст:**
$$C = X^{(R)}$$

#### Расшифрование

Для каждого раунда $r = R, R-1, \ldots, 1$ (в обратном порядке):

**Фаза 1: Обратная двухслойная диффузия**
$$T_3 = \Phi^{-1}(X^{(r)})$$

**Фаза 2: Обратная S-box подстановка**
$$T_2 = \Sigma^{-1}(T_3)$$

**Фаза 3: XOR с раундовым ключом**
$$T_1 = T_2 \oplus RK_r$$

**Фаза 4: 32 обратные перестановки с обратными ротациями**

$$T^{(r)}_{32} = T_1$$

Для каждого $j = 31, 30, \ldots, 0$ (в обратном порядке):
$$op_{r,j} = RK_r[j] \bmod 127$$
$$\text{shift}_{r,j} = ((j + r) \bmod 8) + 1$$
$$Y_{r,j} = \Psi_{-\text{shift}_{r,j}}(T^{(r)}_{j+1})$$
$$T^{(r)}_j = \Pi_{op_{r,j}}^{-1}(Y_{r,j})$$

$$X^{(r-1)} = T^{(r)}_0$$

**Полная формула раунда MODE 1 (расшифрование):**
$$X^{(r-1)} = \left(\prod_{j=0}^{31} \Pi_{op_{r,j}}^{-1} \circ \Psi_{-\text{shift}_{r,j}}\right)\left(\Phi^{-1}(\Sigma^{-1}(X^{(r)})) \oplus RK_r\right)$$

**Итоговый открытый текст:**
$$P = X^{(0)}$$

---

## 4. ОПТИМИЗИРОВАННАЯ ВЕРСИЯ (wbc1_parallel_cached_opti.c)

### 4.1. Кеширование операций

В оптимизированной версии все 127 операций перестановок $\pi_i$ предварительно вычисляются и сохраняются в памяти при инициализации шифра.

**Структура кеша операций:**
```
OperationCache:
  - forward[127][16]  : прямые перестановки
  - inverse[127][16]  : обратные перестановки
```

Где:
- `forward[i][j]` — новая позиция байта $j$ после применения операции $\pi_i$
- `inverse[i][j]` — исходная позиция байта $j$ до применения операции $\pi_i$

**Применение операции:**
$$\Pi_i(X) = (x_{\text{forward}[i][0]}, x_{\text{forward}[i][1]}, \ldots, x_{\text{forward}[i][15]})$$

**Обратная операция:**
$$\Pi_i^{-1}(X) = (x_{\text{inverse}[i][0]}, x_{\text{inverse}[i][1]}, \ldots, x_{\text{inverse}[i][15]})$$

**Преимущества:**
- Устраняет необходимость повторного вычисления перестановок
- Ускорение: 10-50× по сравнению с базовой версией
- Без потери криптографической стойкости

### 4.2. Кеширование ротаций

Циклические побитовые сдвиги также предварительно вычисляются для всех возможных значений байтов.

**Структура кеша ротаций:**
```
RotationCache:
  - forward[8][16][256]  : прямые ротации (вправо)
  - inverse[8][16][256]  : обратные ротации (влево)
```

Где:
- Первый индекс [0..7] соответствует величине сдвига $\text{shift} \in \{1, 2, \ldots, 8\}$
- Второй индекс [0..15] соответствует позиции байта в блоке
- Третий индекс [0..255] соответствует значению байта

**Кеширование прямых ротаций:**
$$\text{forward}[\text{shift}-1][i][b] = \text{ROT}_r(b, \text{shift})$$

**Кеширование обратных ротаций:**
$$\text{inverse}[\text{shift}-1][i][b] = \text{ROT}_\ell(b, \text{shift})$$

**Применение кешированной ротации:**
$$\Psi_{\text{shift}}(X) = (\text{forward}[\text{shift}-1][0][x_0], \text{forward}[\text{shift}-1][1][x_1], \ldots, \text{forward}[\text{shift}-1][15][x_{15}])$$

**Преимущества:**
- Устраняет побитовые операции сдвига
- Дополнительное ускорение: 15-30%
- 100% попадание в кеш (все значения предвычислены)
- Память: 128 КБ (8 сдвигов × 16 байт × 256 значений)

### 4.3. Алгоритм шифрования с кешированием

Алгоритм остается **идентичным** улучшенной версии, но используются предвычисленные значения:

**MODE 0 с кешированием:**
$$X^{(r)} = \left(\prod_{j=31}^{0} \Psi^{\text{cached}}_{\text{shift}_{r,j}} \circ \Pi^{\text{cached}}_{op_{r,j}}\right)(X^{(r-1)})$$

**MODE 1 с кешированием:**
$$X^{(r)} = \Phi\left(\Sigma\left(\left[\left(\prod_{j=31}^{0} \Psi^{\text{cached}}_{\text{shift}_{r,j}} \circ \Pi^{\text{cached}}_{op_{r,j}}\right)(X^{(r-1)})\right] \oplus RK_r\right)\right)$$

где $\Pi^{\text{cached}}$ и $\Psi^{\text{cached}}$ обозначают использование кешированных значений.

---

## 5. ДЕТАЛЬНОЕ ОПИСАНИЕ ОПЕРАЦИЙ

### 5.1. Генерация S-box

**Алгоритм:**
1. Вычислить хеш ключа: $H = \text{SHA-256}(K)$
2. Использовать первые 4 байта как seed: $\text{seed} = (h_0 \ll 24) \mathbin| (h_1 \ll 16) \mathbin| (h_2 \ll 8) \mathbin| h_3$
3. Инициализировать Mersenne Twister MT19937 с $\text{seed}$
4. Генерировать случайную перестановку чисел $0, 1, \ldots, 255$:
   $$S = \text{MT19937-shuffle}([0, 1, 2, \ldots, 255])$$

**Обратный S-box:**
$$S^{-1}[S[i]] = i, \quad \forall i \in \{0, 1, \ldots, 255\}$$

### 5.2. Генерация операций перестановок

#### 5.2.1. Концепция операций перестановок

Блок из 16 байтов представляется как куб Рубика размером 2×2×4:
```
Слой 0:  [x₀  x₁]    Слой 1:  [x₄  x₅]
         [x₂  x₃]             [x₆  x₇]

Слой 2:  [x₈  x₉]    Слой 3:  [x₁₂ x₁₃]
         [x₁₀ x₁₁]            [x₁₄ x₁₅]
```

**Операция перестановки $\pi_i$:**
- Оперирует **индексами** байтов: $\pi_i: \{0,1,\ldots,15\} \to \{0,1,\ldots,15\}$
- Является биекцией (взаимно-однозначным отображением)
- Переставляет **позиции** байтов, не изменяя их **значения**

**Применение к блоку:**
$$\Pi_i(X) = (x_{\pi_i(0)}, x_{\pi_i(1)}, x_{\pi_i(2)}, \ldots, x_{\pi_i(15)})$$

**Конкретный пример:**

Пусть операция $\pi_{23}$ соответствует повороту правой грани (R) и определяется как:
$$\pi_{23} = \begin{pmatrix} 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12 & 13 & 14 & 15 \\ 0 & 5 & 2 & 1 & 4 & 13 & 6 & 3 & 8 & 7 & 10 & 9 & 12 & 15 & 14 & 11 \end{pmatrix}$$

Это означает:
- Байт с позиции 0 остается на позиции 0
- Байт с позиции 1 перемещается на позицию 5
- Байт с позиции 5 перемещается на позицию 13
- И так далее...

**Применение к блоку $X = (a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p)$:**
$$\Pi_{23}(X) = (a, f, c, b, e, n, g, d, i, h, k, j, m, p, o, l)$$

**Обратная операция $\pi_{23}^{-1}$:**
$$\pi_{23}^{-1} = \begin{pmatrix} 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12 & 13 & 14 & 15 \\ 0 & 3 & 2 & 7 & 4 & 1 & 6 & 9 & 8 & 11 & 10 & 15 & 12 & 5 & 14 & 13 \end{pmatrix}$$

Проверка: $\Pi_{23}^{-1}(\Pi_{23}(X)) = X$

#### 5.2.2. Состав 127 операций

**127 операций** состоят из:
- **107 базовых операций**: 
  - Face moves (повороты граней): F, B, U, D, L, R и их варианты (F', F2, ...)
  - Slice moves (средние слои): M, E, S
  - Wide moves (двойные слои): Fw, Bw, Uw, Dw, Lw, Rw
  - Swap operations (обмены): различные обмены пар байтов
  - Cube rotations (вращения всего куба): x, y, z
  - Алгоритмические последовательности
  - Паттерны и диагональные перевороты
  
- **20 динамических операций**: композиции 2-6 базовых операций
  - Пример: $\pi_{107} = \pi_{23} \circ \pi_{45} \circ \pi_{12}$ (композиция 3 поворотов)
  
**Выбор операции для раунда $r$ и индекса $j$:**
$$op_{r,j} = RK_r[j] \bmod 127$$

Это обеспечивает:
- Уникальность операций для каждого ключа
- Разнообразие операций в каждом раунде
- Детерминированность (одинаковый ключ → одинаковые операции)

### 5.3. Двухслойная диффузия $\Phi(X)$

**Прямая диффузия (шифрование):**

Слой 1 (forward cumulative XOR):
$$\Phi_1(X): \quad y_0 = x_0, \quad y_i = x_i \oplus y_{i-1}, \quad i = 1, 2, \ldots, 15$$

Слой 2 (backward cumulative XOR):
$$\Phi_2(Y): \quad z_{15} = y_{15}, \quad z_i = y_i \oplus z_{i+1}, \quad i = 14, 13, \ldots, 0$$

$$\Phi(X) = \Phi_2(\Phi_1(X))$$

**Обратная диффузия (расшифрование):**

Обратный слой 2:
$$\Phi_2^{-1}(Z): \quad y_{15} = z_{15}, \quad y_i = z_i \oplus z_{i+1}, \quad i = 14, 13, \ldots, 0$$

Обратный слой 1:
$$\Phi_1^{-1}(Y): \quad x_0 = y_0, \quad x_i = y_i \oplus y_{i-1}, \quad i = 1, 2, \ldots, 15$$

$$\Phi^{-1}(Z) = \Phi_1^{-1}(\Phi_2^{-1}(Z))$$

**Свойство:**
$$\Phi^{-1}(\Phi(X)) = X$$

### 5.4. Циклический побитовый сдвиг

**Сдвиг вправо на $\ell$ бит:**
$$\text{ROT}_r(b, \ell) = \frac{b}{2^\ell} \bmod 1 + \left\lfloor \frac{b}{2^\ell} \right\rfloor \cdot 2^{8-\ell}$$

Или в битовой нотации:
$$\text{ROT}_r(b, \ell) = (b \gg \ell) \mathbin| ((b \bmod 2^\ell) \ll (8-\ell))$$

**Сдвиг влево на $\ell$ бит:**
$$\text{ROT}_\ell(b, \ell) = (2^\ell \cdot b) \bmod 256 + \left\lfloor \frac{2^\ell \cdot b}{256} \right\rfloor$$

Или в битовой нотации:
$$\text{ROT}_\ell(b, \ell) = (b \ll \ell) \mathbin| (b \gg (8-\ell))$$

**Применение к блоку:**
$$\Psi_\ell(X) = (\text{ROT}_r(x_0, \ell), \text{ROT}_r(x_1, \ell), \ldots, \text{ROT}_r(x_{15}, \ell))$$

**Обратная операция:**
$$\Psi_{-\ell}(X) = \Psi_\ell^{-1}(X) = (\text{ROT}_\ell(x_0, \ell), \text{ROT}_\ell(x_1, \ell), \ldots, \text{ROT}_\ell(x_{15}, \ell))$$

---

## 6. СРАВНЕНИЕ ВЕРСИЙ

### 6.1. Сложность операций на раунд

| Версия | MODE 0 | MODE 1 |
|--------|--------|--------|
| **Базовая** | 1 перестановка + 1 ротация | 1 перестановка + XOR + S-box + диффузия + ротация |
| **Улучшенная** | 32 перестановки + 32 ротации | 32 перестановки + 32 ротации + XOR + S-box + диффузия |
| **Оптимизированная** | То же, но с кешированием | То же, но с кешированием |

### 6.2. Ожидаемые криптографические свойства

| Версия | MODE 0 (лавинный эффект) | MODE 1 (лавинный эффект) |
|--------|--------------------------|--------------------------|
| **Базовая** | ~0.78% (слабый) | ~45-50% (отличный) |
| **Улучшенная** | ~15-25% (хороший) | ~45-50% (отличный) |
| **Оптимизированная** | ~15-25% (хороший) | ~45-50% (отличный) |

### 6.3. Производительность

| Версия | Относительная скорость | Память |
|--------|------------------------|--------|
| **Базовая (non-cached)** | 1× (базовая) | 2 КБ |
| **Базовая (cached)** | 10-50× | 4 КБ |
| **Улучшенная (non-cached)** | 1/32× (медленнее из-за 32 операций) | 2 КБ |
| **Улучшенная (cached)** | 1/3× | 4 КБ |
| **Оптимизированная (cached + rotation cache)** | 1/2× | 132 КБ |

---

## 7. РЕКОМЕНДАЦИИ ПО ИСПОЛЬЗОВАНИЮ

### 7.1. Выбор версии алгоритма

**Для максимальной криптографической стойкости:**
- Использовать **MODE 1** (полный алгоритм)
- Улучшенная или оптимизированная версия
- Минимум 16 раундов, рекомендуется 32

**Для баланса скорость/стойкость:**
- Использовать **MODE 0** (упрощенный)
- Улучшенная версия (не базовая!)
- Минимум 32 раунда

**Для максимальной производительности:**
- Использовать оптимизированную версию с кешированием
- MODE 0 или MODE 1 в зависимости от требований
- Учитывать накладные расходы на инициализацию

### 7.2. Размеры ключа

- **k = 128**: базовый уровень безопасности
- **k = 192**: повышенный уровень
- **k = 256**: максимальный уровень (рекомендуется)

### 7.3. Количество раундов

| Режим | Минимум | Рекомендуется | Высокая безопасность |
|-------|---------|---------------|----------------------|
| MODE 0 (базовая) | Не рекомендуется | Не рекомендуется | Не рекомендуется |
| MODE 0 (улучшенная) | 16 | 32 | 64 |
| MODE 1 (любая версия) | 10 | 16 | 32 |

---

## 8. ЗАКЛЮЧЕНИЕ

Представленное описание охватывает все модификации алгоритма блочного шифра WBC1:

1. **Базовая версия** — оригинальный алгоритм с 1 операцией на раунд
2. **Улучшенная версия** — расширенный алгоритм с 32 операциями на раунд для улучшенного лавинного эффекта
3. **Оптимизированная версия** — высокопроизводительная реализация с кешированием операций и ротаций

Все версии обеспечивают:
- Корректное шифрование и расшифрование (обратимость)
- Детерминированность (одинаковый ключ → одинаковый результат)
- Различные компромиссы между скоростью и криптографической стойкостью

**Рекомендация для научной публикации:** Использовать улучшенную версию MODE 1 как основную, с описанием оптимизаций как способа повышения производительности без потери стойкости.

---

**Дата создания:** 2026-02-05  
**Версия документа:** 1.0  
**Статус:** Готов для использования в научной статье
