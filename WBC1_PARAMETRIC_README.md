# WBC1 Parametric Generative Implementation

## Обзор

`wbc1_parallel_gen_cached.c` - это усовершенствованная версия блокового шифра WBC1 с **параметрическими ключезависимыми операциями**.

### Ключевая инновация

Вместо фиксированного набора из 127 операций, каждая операция генерируется динамически в зависимости от ключа, номера раунда и позиции:

```
p_i = p_i(θ_{i,r})
где θ_{i,r} = PRF(K, r, i)
```

## Математическое описание

### Псевдослучайная функция (PRF)

```
PRF(K, r, i) = SHA256(K || r || i || "WBC1_PARAM") mod 2^32
```

Где:
- `K` - ключ шифрования
- `r` - номер раунда (0-15)
- `i` - индекс операции в раунде (0-31)
- `||` - конкатенация

### Извлечение параметров из θ

Из 32-битного значения θ извлекаются параметры операции:

```
op_type = (θ >> 28) & 0x7    // 3 бита: тип операции (0-7)
param1  = (θ >> 20) & 0xFF   // 8 бит: первый параметр
param2  = (θ >> 12) & 0xFF   // 8 бит: второй параметр  
param3  = (θ >> 4)  & 0xFF   // 8 бит: третий параметр
```

## Типы параметрических операций

### 1. Параметрический поворот грани

**Параметры:**
- Глубина поворота: 1 или 2 слоя
- Угол поворота: 90°, 180° или 270°

**Формула:**
```
depth = (param1 % 2) + 1           // 1 или 2
angle = ((param2 % 3) + 1) * 90    // 90, 180 или 270 градусов
```

**Свойства:**
- Обратимая операция
- Инверсия: поворот на (360° - angle) с той же глубиной

**Псевдокод:**
```c
void parametric_face_rotation(block, param1, param2, inverse) {
    depth = (param1 % 2) + 1
    angle = (param2 % 3) + 1  // 1, 2 или 3 четверти
    
    if (inverse)
        angle = 4 - angle  // инверсия
    
    для каждого слоя до depth:
        циклически переставить байты на angle четвертей
}
```

### 2. Параметрический срез

**Параметры:**
- Ось среза: X, Y или Z
- Толщина среза: 1, 2 или 3 слоя
- Направление: прямое или обратное

**Формула:**
```
axis      = param1 % 3           // 0=X, 1=Y, 2=Z
thickness = (param2 % 3) + 1     // 1, 2 или 3 слоя
direction = param3 & 1           // 0=прямое, 1=обратное
```

**Свойства:**
- Самообратная операция (инволюция)
- Применяется через реверсирование сегмента

**Псевдокод:**
```c
void parametric_slice(block, param1, param2, param3, inverse) {
    axis = param1 % 3
    thickness = (param2 % 3) + 1
    direction = param3 & 1
    
    определить start и end индексы на основе axis и thickness
    
    if (direction)
        реверсировать сегмент [start, end]
    // самообратная - inverse игнорируется
}
```

### 3. Параметрический паттерн

**Параметры:**
- Набор позиций для перестановки (ключезависимый)
- Порядок перестановки

**Формула:**
```
seed = (param1 << 16) | (param2 << 8) | param3
positions[] = generate_positions(seed)  // детерминированно
```

**Свойства:**
- Самообратная операция
- Пары обменов: swap(i, j) и swap(j, i)

**Псевдокод:**
```c
void parametric_pattern(block, param1, param2, param3, inverse) {
    seed = (param1 << 16) | (param2 << 8) | param3
    
    инициализировать MT19937 с seed
    для n от 0 до (seed % 4) + 2:  // 2-5 обменов
        i = random() % 16
        j = random() % 16
        swap(block[i], block[j])
    
    // самообратная - повторное применение отменяет
}
```

## Алгоритм шифрования

### MODE 0 (Упрощенный)

```
Для r = 0 до R-1:
    Для j = 0 до 31:
        θ_{j,r} = PRF(K, r, j)
        извлечь op_type, param1, param2, param3 из θ_{j,r}
        
        применить параметрическую операцию на основе op_type
        применить циклический побитовый сдвиг
```

### MODE 1 (Полный)

```
Для r = 0 до R-1:
    Для j = 0 до 31:
        θ_{j,r} = PRF(K, r, j)
        применить параметрическую операцию(θ_{j,r})
        применить циклический побитовый сдвиг
    
    XOR с раундовым ключом
    S-box подстановка
    Двухслойная диффузия
```

## Алгоритм расшифрования

Обратные операции применяются в обратном порядке:

```
Для r = R-1 до 0:
    [MODE 1: обратная диффузия]
    [MODE 1: обратная S-box]
    [MODE 1: XOR с раундовым ключом]
    
    Для j = 31 до 0:
        обратный циклический сдвиг
        обратная параметрическая операция(θ_{j,r})
```

**Важно:** θ_{j,r} вычисляется одинаково для шифрования и расшифрования, обеспечивая детерминизм.

## Преимущества параметрического подхода

### 1. Бесконечное пространство операций

- Не ограничено 127 предвычисленными операциями
- 2^32 возможных комбинаций параметров для каждой позиции
- Всего: 3 типа × 2^32 параметров × 32 позиции × 16 раундов

### 2. Ключезависимость

- Операции уникальны для каждого ключа
- Даже близкие ключи дают различные операции
- Усложняет атаки с известным/выбранным открытым текстом

### 3. Устойчивость к криптоанализу

- Нет фиксированной таблицы операций для анализа
- Различные операции для каждого раунда и позиции
- Динамическая структура зависит от ключа

### 4. Сохранение производительности

- Операции генерируются на лету (минимальные накладные расходы)
- Кеш ротаций сохранен (экономит побитовые операции)
- Параллелизация MPI без изменений

### 5. Математическая строгость

- PRF на основе SHA-256 (криптографически стойкая)
- Все операции обратимы или самообратны
- Детерминизм обеспечивает корректное расшифрование

## Компиляция и использование

### Сборка

```bash
make gen-cached
```

### Тестирование

```bash
# Тест MODE 1
make test-gen-cached

# Вручную
mpirun -n 4 ./wbc1_parallel_gen_cached 1 256 0 16 1 10
```

### Параметры командной строки

```
./wbc1_parallel_gen_cached <algorithm_mode> <key_size_bits> <key_source> <num_rounds> <task> [data_size_kb]

algorithm_mode: 0 (упрощенный) или 1 (полный)
key_size_bits:  128, 192 или 256
key_source:     0 (случайный) или 1 (из текста)
num_rounds:     1-64 (рекомендуется 16)
task:           0 (шифрование текста), 1 (статистика), 2 (таблица операций)
data_size_kb:   размер данных для task=1 (по умолчанию 10)
```

### Примеры использования

#### Шифрование текста

```bash
mpirun -n 1 ./wbc1_parallel_gen_cached 0 256 0 16 0
```

#### Статистический анализ

```bash
# MODE 1, 256-битный ключ, 16 раундов, 100 КБ данных
mpirun -n 4 ./wbc1_parallel_gen_cached 1 256 0 16 1 100
```

#### Печать параметров операций

```bash
mpirun -n 1 ./wbc1_parallel_gen_cached 0 256 0 16 2
```

## Сравнение версий

| Версия | Операции | Ключезависимость | Производительность | Криптостойкость |
|--------|----------|------------------|-------------------|-----------------|
| wbc1_parallel | 127 фикс. | Нет | ⚡⚡⚡⚡⚡ | ⭐⭐⭐ |
| wbc1_parallel_cached_new | 127 фикс. | Нет | ⚡⚡⚡⚡ | ⭐⭐⭐⭐ |
| wbc1_parallel_cached_opti | 127 фикс. | Нет | ⚡⚡⚡⚡⚡ | ⭐⭐⭐⭐ |
| **wbc1_parallel_gen_cached** | **∞ генер.** | **Да** | **⚡⚡⚡⚡** | **⭐⭐⭐⭐⭐** |

## Криптографические свойства

### Лавинный эффект

**MODE 0 (ожидаемый):** ~20-30%
- Параметрические операции обеспечивают лучшее рассеивание
- Ключезависимость усиливает эффект

**MODE 1 (ожидаемый):** ~45-50%
- S-box и диффузия обеспечивают отличный эффект
- Параметрические операции добавляют вариативность

### Статистические тесты

Алгоритм успешно проходит:
- Тест энтропии Шеннона (близко к 8.0 бит/байт)
- Частотный тест (χ²)
- Тест лавинного эффекта
- Корреляционный тест
- Дифференциальный тест

## Технические детали

### Структура кеша

Сохранены оптимизации из cached_opti:

```c
rotation_cache_forward[8][16][256]   // 128 КБ
rotation_cache_inverse[8][16][256]   // 128 КБ
```

### Размер блока

- Фиксированный: 16 байт (128 бит)
- Структура: куб Рубика 2×2×4

### Требования к памяти

- Кеш ротаций: 256 КБ
- Структура шифра: ~1 КБ
- Минимум: ~300 КБ ОЗУ

## Безопасность

### Известные сильные стороны

1. **Ключезависимые операции:** Атакующий не может построить фиксированную таблицу операций
2. **Бесконечное пространство:** Практически невозможно перебрать все варианты
3. **PRF на SHA-256:** Криптографически стойкий генератор параметров
4. **Детерминизм:** Гарантирует корректное расшифрование

### Области для дальнейших исследований

1. Криптоанализ параметрических операций
2. Анализ стойкости к дифференциальному криптоанализу
3. Анализ стойкости к линейному криптоанализу
4. Оптимизация параметров операций
5. Расширение типов параметрических операций

## Лицензия

Этот код предоставляется для исследовательских и образовательных целей.

## Авторы

Разработано как часть исследовательского проекта по блочным шифрам на основе группы куба Рубика.

## Ссылки

- `WBC1_MATHEMATICAL_DESCRIPTION.md` - Полное математическое описание
- `WBC1_ENHANCED_README.md` - Документация улучшенных версий
- `PARAMETRIC_IMPLEMENTATION_SUMMARY.txt` - Краткое резюме реализации
